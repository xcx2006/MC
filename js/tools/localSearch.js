export default function initLocalSearch(){let e=config.path;if(!e){console.warn("`hexo-generator-searchdb` plugin is not installed!");return}let t=false;let n;let r=true;if(e.length===0){e="search.xml"}else if(e.endsWith("json")){r=false}const l=document.querySelector(".search-input");const o=document.getElementById("search-result");const s=(e,t,n)=>{let r=e.length;if(r===0)return[];let l=0;let o=[];let s=[];if(!n){t=t.toLowerCase();e=e.toLowerCase()}while((o=t.indexOf(e,l))>-1){s.push({position:o,word:e});l=o+r}return s};const i=(e,t,n,r)=>{let l=n[n.length-1];let{position:o,word:s}=l;let i=[];let a=0;while(o+s.length<=t&&n.length!==0){if(s===r){a++}i.push({position:o,length:s.length});const e=o+s.length;n.pop();for(let t=n.length-1;t>=0;t--){l=n[t];o=l.position;s=l.word;if(e<=o){break}else{n.pop()}}}return{hits:i,start:e,end:t,searchTextCount:a}};const a=(e,t)=>{let n="";let r=t.start;t.hits.forEach((t=>{n+=e.substring(r,t.position);let l=t.position+t.length;n+=`<b class="search-keyword">${e.substring(t.position,l)}</b>`;r=l}));n+=e.substring(r,t.end);return n};const c=()=>{if(!t)return;let e=l.value.trim().toLowerCase();let r=e.split(/[-\s]+/);if(r.length>1){r.push(e)}let c=[];if(e.length>0){n.forEach((({title:t,content:n,url:l})=>{let o=t.toLowerCase();let h=n.toLowerCase();let u=[];let f=[];let p=0;r.forEach((e=>{u=u.concat(s(e,o,false));f=f.concat(s(e,h,false))}));if(u.length>0||f.length>0){let r=u.length+f.length;[u,f].forEach((e=>{e.sort(((e,t)=>{if(t.position!==e.position){return t.position-e.position}return e.word.length-t.word.length}))}));let o=[];if(u.length!==0){let n=i(0,t.length,u,e);p+=n.searchTextCountInSlice;o.push(n)}let s=[];while(f.length!==0){let t=f[f.length-1];let{position:r,word:l}=t;let o=r-20;let a=r+80;if(o<0){o=0}if(a<r+l.length){a=r+l.length}if(a>n.length){a=n.length}let c=i(o,a,f,e);p+=c.searchTextCountInSlice;s.push(c)}s.sort(((e,t)=>{if(e.searchTextCount!==t.searchTextCount){return t.searchTextCount-e.searchTextCount}else if(e.hits.length!==t.hits.length){return t.hits.length-e.hits.length}return e.start-t.start}));let h=parseInt(theme.navbar.search.top_n_per_article?theme.navbar.search.top_n_per_article:1,10);if(h>=0){s=s.slice(0,h)}let d="";if(o.length!==0){d+=`<li><a href="${l}" class="search-result-title">${a(t,o[0])}</a>`}else{d+=`<li><a href="${l}" class="search-result-title">${t}</a>`}s.forEach((e=>{d+=`<a href="${l}"><p class="search-result">${a(n,e)}...</p></a>`}));d+="</li>";c.push({item:d,id:c.length,hitCount:r,searchTextCount:p})}}))}if(r.length===1&&r[0]===""){o.innerHTML='<div id="no-result"><i class="fa-solid fa-magnifying-glass fa-5x"></i></div>'}else if(c.length===0){o.innerHTML='<div id="no-result"><i class="fa-solid fa-box-open fa-5x"></i></div>'}else{c.sort(((e,t)=>{if(e.searchTextCount!==t.searchTextCount){return t.searchTextCount-e.searchTextCount}else if(e.hitCount!==t.hitCount){return t.hitCount-e.hitCount}return t.id-e.id}));let e='<ul class="search-result-list">';c.forEach((t=>{e+=t.item}));e+="</ul>";o.innerHTML=e;window.pjax&&window.pjax.refresh(o)}};const h=()=>{fetch(config.root+e).then((e=>e.text())).then((e=>{t=true;n=r?[...(new DOMParser).parseFromString(e,"text/xml").querySelectorAll("entry")].map((e=>({title:e.querySelector("title").textContent,content:e.querySelector("content").textContent,url:e.querySelector("url").textContent}))):JSON.parse(e);n=n.filter((e=>e.title)).map((e=>{e.title=e.title.trim();e.content=e.content?e.content.trim().replace(/<[^>]+>/g,""):"";e.url=decodeURIComponent(e.url).replace(/\/{2,}/g,"/");return e}));const l=document.querySelector("#no-result");l&&(l.innerHTML='<i class="fa-solid fa-magnifying-glass fa-5x"></i>')}))};if(theme.navbar.search.preload){h()}if(l){l.addEventListener("input",c)}document.querySelectorAll(".search-popup-trigger").forEach((e=>{e.addEventListener("click",(()=>{document.body.style.overflow="hidden";document.querySelector(".search-pop-overlay").classList.add("active");setTimeout((()=>l.focus()),500);if(!t)h()}))}));const u=()=>{document.body.style.overflow="";document.querySelector(".search-pop-overlay").classList.remove("active")};document.querySelector(".search-pop-overlay").addEventListener("click",(e=>{if(e.target===document.querySelector(".search-pop-overlay")){u()}}));document.querySelector(".search-input-field-pre").addEventListener("click",(()=>{l.value="";l.focus();c()}));document.querySelector(".popup-btn-close").addEventListener("click",u);try{swup.hooks.on("page:view",(e=>{u()}))}catch(e){}window.addEventListener("keyup",(e=>{if(e.key==="Escape"){u()}}))}