Global.initLocalSearch=()=>{let e=Global.hexo_config.path;if(!e){console.warn("`hexo-generator-searchdb` plugin is not installed!");return}let t=false;let n;let l=true;if(e.length===0){e="search.xml"}else if(e.endsWith("json")){l=false}const r=document.querySelector(".search-input");const o=document.getElementById("search-result");const s=(e,t,n)=>{let l=e.length;if(l===0)return[];let r=0;let o=[];let s=[];if(!n){t=t.toLowerCase();e=e.toLowerCase()}while((o=t.indexOf(e,r))>-1){s.push({position:o,word:e});r=o+l}return s};const i=(e,t,n,l)=>{let r=n[n.length-1];let{position:o,word:s}=r;let i=[];let a=0;while(o+s.length<=t&&n.length!==0){if(s===l){a++}i.push({position:o,length:s.length});const e=o+s.length;n.pop();for(let t=n.length-1;t>=0;t--){r=n[t];o=r.position;s=r.word;if(e<=o){break}else{n.pop()}}}return{hits:i,start:e,end:t,searchTextCount:a}};const a=(e,t)=>{let n="";let l=t.start;t.hits.forEach((t=>{n+=e.substring(l,t.position);let r=t.position+t.length;n+=`<b class="search-keyword">${e.substring(t.position,r)}</b>`;l=r}));n+=e.substring(l,t.end);return n};const c=()=>{if(!t)return;let e=r.value.trim().toLowerCase();let l=e.split(/[-\s]+/);if(l.length>1){l.push(e)}let c=[];if(e.length>0){n.forEach((({title:t,content:n,url:r})=>{let o=t.toLowerCase();let h=n.toLowerCase();let u=[];let f=[];let d=0;l.forEach((e=>{u=u.concat(s(e,o,false));f=f.concat(s(e,h,false))}));if(u.length>0||f.length>0){let l=u.length+f.length;[u,f].forEach((e=>{e.sort(((e,t)=>{if(t.position!==e.position){return t.position-e.position}return e.word.length-t.word.length}))}));let o=[];if(u.length!==0){let n=i(0,t.length,u,e);d+=n.searchTextCountInSlice;o.push(n)}let s=[];while(f.length!==0){let t=f[f.length-1];let{position:l,word:r}=t;let o=l-20;let a=l+80;if(o<0){o=0}if(a<l+r.length){a=l+r.length}if(a>n.length){a=n.length}let c=i(o,a,f,e);d+=c.searchTextCountInSlice;s.push(c)}s.sort(((e,t)=>{if(e.searchTextCount!==t.searchTextCount){return t.searchTextCount-e.searchTextCount}else if(e.hits.length!==t.hits.length){return t.hits.length-e.hits.length}return e.start-t.start}));let h=parseInt(Global.theme_config.navbar.search.top_n_per_article?Global.theme_config.navbar.search.top_n_per_article:1,10);if(h>=0){s=s.slice(0,h)}let p="";if(o.length!==0){p+=`<li><a href="${r}" class="search-result-title">${a(t,o[0])}</a>`}else{p+=`<li><a href="${r}" class="search-result-title">${t}</a>`}s.forEach((e=>{p+=`<a href="${r}"><p class="search-result">${a(n,e)}...</p></a>`}));p+="</li>";c.push({item:p,id:c.length,hitCount:l,searchTextCount:d})}}))}if(l.length===1&&l[0]===""){o.innerHTML='<div id="no-result"><i class="fa-solid fa-magnifying-glass fa-5x"></i></div>'}else if(c.length===0){o.innerHTML='<div id="no-result"><i class="fa-solid fa-box-open fa-5x"></i></div>'}else{c.sort(((e,t)=>{if(e.searchTextCount!==t.searchTextCount){return t.searchTextCount-e.searchTextCount}else if(e.hitCount!==t.hitCount){return t.hitCount-e.hitCount}return t.id-e.id}));let e='<ul class="search-result-list">';c.forEach((t=>{e+=t.item}));e+="</ul>";o.innerHTML=e;window.pjax&&window.pjax.refresh(o)}};const h=()=>{fetch(Global.hexo_config.root+e).then((e=>e.text())).then((e=>{t=true;n=l?[...(new DOMParser).parseFromString(e,"text/xml").querySelectorAll("entry")].map((e=>({title:e.querySelector("title").textContent,content:e.querySelector("content").textContent,url:e.querySelector("url").textContent}))):JSON.parse(e);n=n.filter((e=>e.title)).map((e=>{e.title=e.title.trim();e.content=e.content?e.content.trim().replace(/<[^>]+>/g,""):"";e.url=decodeURIComponent(e.url).replace(/\/{2,}/g,"/");return e}));const r=document.querySelector("#no-result");r&&(r.innerHTML='<i class="fa-solid fa-magnifying-glass fa-5x"></i>')}))};if(Global.theme_config.navbar.search.preload){h()}if(r){r.addEventListener("input",c)}document.querySelectorAll(".search-popup-trigger").forEach((e=>{e.addEventListener("click",(()=>{document.body.style.overflow="hidden";document.querySelector(".search-pop-overlay").classList.add("active");setTimeout((()=>r.focus()),500);if(!t)h()}))}));const u=()=>{document.body.style.overflow="";document.querySelector(".search-pop-overlay").classList.remove("active")};document.querySelector(".search-pop-overlay").addEventListener("click",(e=>{if(e.target===document.querySelector(".search-pop-overlay")){u()}}));document.querySelector(".search-input-field-pre").addEventListener("click",(()=>{r.value="";r.focus();c()}));document.querySelector(".popup-btn-close").addEventListener("click",u);window.addEventListener("pjax:success",u);window.addEventListener("keyup",(e=>{if(e.key==="Escape"){u()}}))};