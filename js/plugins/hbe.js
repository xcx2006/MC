(()=>{"use strict";const e=window.crypto||window.msCrypto;const t=window.localStorage;const n="hexo-blog-encrypt:#"+window.location.pathname;const o=f("hexo-blog-encrypt的作者们都是大帅比!");const r=f("hexo-blog-encrypt是地表最强Hexo加密插件!");const a="<hbe-prefix></hbe-prefix>";const c=document.getElementById("hexo-blog-encrypt");const s=c.dataset["wpm"];const i=c.dataset["whm"];const l=c.getElementsByTagName("script")["hbeData"];const d=l.innerText;const u=l.dataset["hmacdigest"];function y(e){return new Uint8Array(e.match(/[\da-f]{2}/gi).map((e=>parseInt(e,16))))}function f(e){var t=e.length;var n=0;var o=new Array;for(var r=0;r<t;){var a=e.codePointAt(r);if(a<128){o[n++]=a;r++}else if(a>127&&a<2048){o[n++]=a>>6|192;o[n++]=a&63|128;r++}else if(a>2047&&a<65536){o[n++]=a>>12|224;o[n++]=a>>6&63|128;o[n++]=a&63|128;r++}else{o[n++]=a>>18|240;o[n++]=a>>12&63|128;o[n++]=a>>6&63|128;o[n++]=a&63|128;r+=2}}return new Uint8Array(o)}function h(e){if(typeof e!=="object"||e===null||typeof e.byteLength!=="number"){throw new TypeError("Expected input to be an ArrayBuffer")}var t=new Uint8Array(e);var n="";var o;for(var r=0;r<t.length;r++){o=t[r].toString(16);n+=o.length===1?"0"+o:o}return n}async function m(e){let t=document.createElement("script");const n=["type","text","src","crossorigin","defer","referrerpolicy"];n.forEach((n=>{if(e[n])t[n]=e[n]}));return t}async function g(e){let t=document.createElement("div");t.innerHTML=e;t.querySelectorAll("script").forEach((async e=>{e.replaceWith(await m(e))}));return t}function p(t){let n=new TextEncoder;return e.subtle.importKey("raw",n.encode(t),{name:"PBKDF2"},false,["deriveKey","deriveBits"])}function w(t){return e.subtle.deriveKey({name:"PBKDF2",hash:"SHA-256",salt:o.buffer,iterations:1024},t,{name:"HMAC",hash:"SHA-256",length:256},true,["verify"])}function b(t){return e.subtle.deriveKey({name:"PBKDF2",hash:"SHA-256",salt:o.buffer,iterations:1024},t,{name:"AES-CBC",length:256},true,["decrypt"])}function v(t){return e.subtle.deriveBits({name:"PBKDF2",hash:"SHA-256",salt:r.buffer,iterations:512},t,16*8)}async function E(t,n){const o=new TextEncoder;const r=o.encode(n);let a=y(u);const c=await e.subtle.verify({name:"HMAC",hash:"SHA-256"},t,a,r);console.log(`Verification result: ${c}`);if(!c){alert(i);console.log(`${i}, got `,a,` but proved wrong.`)}return c}async function x(t,o,r){let c=y(d);const i=await e.subtle.decrypt({name:"AES-CBC",iv:o},t,c.buffer).then((async e=>{const t=new TextDecoder;const o=t.decode(e);if(!o.startsWith(a)){throw"Decode successfully but not start with KnownPrefix."}const c=document.createElement("button");c.textContent="Encrypt again";c.type="button";c.classList.add("hbe-button");c.addEventListener("click",(()=>{window.localStorage.removeItem(n);window.location.reload()}));document.getElementById("hexo-blog-encrypt").style.display="inline";document.getElementById("hexo-blog-encrypt").innerHTML="";document.getElementById("hexo-blog-encrypt").appendChild(await g(o));document.getElementById("hexo-blog-encrypt").appendChild(c);document.querySelectorAll("img").forEach((e=>{if(e.getAttribute("data-src")&&!e.src){e.src=e.getAttribute("data-src")}}));window.NexT&&NexT.boot&&typeof NexT.boot.refresh==="function"&&NexT.boot.refresh();var s=document.getElementById("toc-div");if(s){s.style.display="inline"}var i=document.getElementsByClassName("toc-div-class");if(i&&i.length>0){for(var l=0;l<i.length;l++){i[l].style.display="inline"}}var d=new Event("hexo-blog-decrypt");window.dispatchEvent(d);return await E(r,o)})).catch((e=>{alert(s);console.log(e);return false}));return i}function A(){const o=JSON.parse(t.getItem(n));if(o){console.log(`Password got from localStorage(${n}): `,o);const r=y(o.iv).buffer;const a=o.dk;const c=o.hmk;e.subtle.importKey("jwk",a,{name:"AES-CBC",length:256},true,["decrypt"]).then((o=>{e.subtle.importKey("jwk",c,{name:"HMAC",hash:"SHA-256",length:256},true,["verify"]).then((e=>{x(o,r,e).then((e=>{if(!e){t.removeItem(n)}}))}))}))}c.addEventListener("keydown",(async o=>{if(o.isComposing||o.key==="Enter"){const o=document.getElementById("hbePass").value;const r=await p(o);const a=await w(r);const c=await b(r);const s=await v(r);x(c,s,a).then((o=>{console.log(`Decrypt result: ${o}`);if(o){e.subtle.exportKey("jwk",c).then((o=>{e.subtle.exportKey("jwk",a).then((e=>{const r={dk:o,iv:h(s),hmk:e};t.setItem(n,JSON.stringify(r))}))}))}}))}}))}A()})();